<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.animal.api.shelter.mapper.UserShelterMapper">
<select id="getAllShelters" parameterType="Map" resultType="com.animal.api.shelter.model.response.AllShelterListDTO">
SELECT
	S.USER_IDX AS 'IDX',
	S.SHELTER_NAME,
	S.SHELTER_ADDRESS,
	ST.NAME AS 'SHELTER_TYPE'
FROM
	SHELTERS S
JOIN SHELTER_TYPES ST
	ON
	S.SHELTER_TYPE_IDX = ST.IDX
ORDER BY
	S.USER_IDX DESC
LIMIT ${listSize} OFFSET ${cp}
</select>
<select id="searchShelters" parameterType="com.animal.api.shelter.model.request.SearchShelterRequestDTO" resultType="com.animal.api.shelter.model.response.AllShelterListDTO">
SELECT
	S.USER_IDX AS 'IDX',
	S.SHELTER_NAME,
	S.SHELTER_ADDRESS,
	ST.NAME AS 'SHELTER_TYPE'
FROM
	SHELTERS S
JOIN SHELTER_TYPES ST
	ON
	S.SHELTER_TYPE_IDX = ST.IDX
<where>
	<if test="shelterAddress != null and shelterAddress != ''">
		AND S.SHELTER_ADDRESS LIKE '%${shelterAddress}%'
	</if>
	<if test="shelterType != null and shelterType != ''">
		AND ST.NAME = #{shelterType}
	</if>
	<if test="shelterName != null and shelterName != ''">
		AND S.SHELTER_NAME LIKE '%${shelterName}%'
	</if>
</where>	
ORDER BY
	S.USER_IDX DESC
LIMIT ${listSize} OFFSET ${cp}
</select>
<select id="getShelterDetail" parameterType="int" resultType="com.animal.api.shelter.model.response.ShelterDetailDTO">
SELECT
	S.USER_IDX AS 'IDX',
	S.SHELTER_NAME,
	S.SHELTER_TEL,
	S.SHELTER_PERSON_NAME,
	S.SHELTER_ADDRESS,
	S.SHELTER_ADDRESS_DETAIL,
	S.SHELTER_EMAIL,
	S.SHELTER_DESCRIPTION,
	(
	SELECT
		COUNT(*)
	FROM
		ANIMALS A
	WHERE
		A.USER_IDX = S.USER_IDX
		AND A.ADOPTION_STATUS_IDX != 3
	) AS ANIMAL_COUNT,
	(
	SELECT
		COUNT(*)
	FROM
		VOLUNTEER_REVIEWS VR
	WHERE
		VR.USER_IDX = ${idx}) + (
	SELECT
		COUNT(*)
	FROM
		ADOPTION_REVIEWS AR
	WHERE
		AR.USER_IDX = ${idx} ) AS 'REVIEW_COUNT',
	ST.NAME AS 'SHELTER_TYPE'
FROM
	SHELTERS S
JOIN SHELTER_TYPES ST
	ON
	S.SHELTER_TYPE_IDX = ST.IDX
WHERE
	S.USER_IDX = ${idx}
</select>
<select id="getShelterVolunteers" parameterType="int" resultType="com.animal.api.shelter.model.response.ShelterVolunteersDTO">
SELECT
	V.IDX,
	V.TITLE,
	s.SHELTER_NAME,
	V.LOCATION,
	VS.NAME AS 'VOLUNTEER_STATUS',
	V.`TIME` AS 'VOLUNTEER_TIME',
	V.CREATED_AT
FROM
	VOLUNTEERS V
JOIN VOLUNTEER_STATUS VS
ON
	V.VOLUNTEER_STATUS_IDX = VS.IDX
JOIN SHELTERS s 
ON
	V.USER_IDX = s.USER_IDX
WHERE
	V.USER_IDX = ${idx}
</select>
</mapper>