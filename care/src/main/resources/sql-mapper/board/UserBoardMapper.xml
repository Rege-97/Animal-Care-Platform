<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.animal.api.board.mapper.UserBoardMapper">
<select id="getAllBoards" parameterType="Map" resultType="com.animal.api.board.model.response.AllBoardListResponseDTO">
SELECT
    B.IDX,
    B.TITLE,
    IFNULL(U.NICKNAME, '탈퇴 회원') AS NICKNAME,
    B.CREATED_AT,
    B.VIEWS,
    COUNT(BL.IDX) AS LIKE_COUNT,
    B.REF,
    B.LEV,
    B.TURN 
FROM
    BOARDS B
LEFT JOIN USERS U ON B.USER_IDX = U.IDX
LEFT JOIN BOARD_LIKES BL ON B.IDX = BL.BOARD_IDX AND BL.IS_LIKE = 1
WHERE
    B.BOARD_TYPE_IDX = 2
GROUP BY
    B.IDX, B.TITLE, B.CREATED_AT, B.VIEWS, U.NICKNAME, B.REF, B.LEV, B.TURN
ORDER BY
    B.REF DESC,      
    B.TURN ASC       
LIMIT #{listSize} OFFSET #{cp}
</select>

<select id="searchBoards" parameterType="com.animal.api.board.model.request.BoardSearchRequestDTO" resultType="com.animal.api.board.model.response.AllBoardListResponseDTO">
SELECT
	B.IDX,
	B.TITLE,
	IFNULL(U.NICKNAME, '탈퇴 회원') AS NICKNAME,
	B.CREATED_AT,
	B.VIEWS,
	COUNT(BL.IDX) AS LIKE_COUNT,
	B.REF,
	B.LEV,
	B.TURN
FROM
	BOARDS B
LEFT JOIN USERS U ON
	B.USER_IDX = U.IDX
LEFT JOIN BOARD_LIKES BL ON
	B.IDX = BL.BOARD_IDX
	AND BL.IS_LIKE = 1
<where>
	B.BOARD_TYPE_IDX = 2

    <choose>
        <when test = "type == 'title' AND keyword != NULL AND keyword != ''">
			AND B.TITLE LIKE CONCAT('%', #{keyword}, '%')
        </when>
        <when test = "type == 'nickname' AND keyword != NULL AND keyword != ''">
            AND U.NICKNAME LIKE CONCAT('%', #{keyword}, '%')
        </when>
        <when test = "type == 'content' AND keyword != NULL AND keyword != ''">
            AND B.CONTENT LIKE CONCAT('%', #{keyword}, '%')
        </when>
        <when test = "(type == 'all' OR type == null) AND keyword != NULL AND keyword != ''">
            AND (
                B.TITLE LIKE CONCAT('%', #{keyword}, '%')
                OR U.NICKNAME LIKE CONCAT('%', #{keyword}, '%')
                OR B.CONTENT LIKE CONCAT('%', #{keyword}, '%')
            )
        </when>
    </choose>
</where>
GROUP BY
    B.IDX, B.TITLE, B.CREATED_AT, B.VIEWS, U.NICKNAME, B.REF, B.LEV, B.TURN
ORDER BY
    B.REF DESC,
    B.TURN ASC
LIMIT #{listSize} OFFSET #{cp}
</select>
</mapper>